name: Release Dry Run

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Test version (leave empty for patch bump)'
        required: false
        type: string

jobs:
  dry-run:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg-passphrase: GPG_PASSPHRASE
        
    - name: Test version bump
      run: |
        echo "Current version: $(mvn -B help:evaluate -Dexpression=project.version -q -DforceStdout)"
        if [ -n "${{ github.event.inputs.version }}" ]; then
          mvn -B versions:set -DnewVersion=${{ github.event.inputs.version }}
          echo "Would set version to: ${{ github.event.inputs.version }}"
        else
          mvn -B build-helper:parse-version versions:set -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion}
          echo "Would bump to: $(mvn -B help:evaluate -Dexpression=project.version -q -DforceStdout)"
        fi
        mvn -B versions:commit
        
    - name: Test build and verify
      run: mvn -B clean verify
        
    - name: Test full release process (dry-run)
      run: |
        echo "Staging artifacts..."
        mkdir -p target/staging-deploy
        mvn -B deploy -DaltDeploymentRepository=local::file:./target/staging-deploy -DskipTests
        echo "Testing full JReleaser release process..."
        mvn -B jreleaser:full-release
      env:
        JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        JRELEASER_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.GPG_PUBLIC_KEY }}
        JRELEASER_GPG_SECRET_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        JRELEASER_MAVENCENTRAL_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
        JRELEASER_DRY_RUN: true
        
    - name: Show what would be released
      run: |
        echo "=== Generated changelog ==="
        if [ -f target/jreleaser/release/CHANGELOG.md ]; then
          cat target/jreleaser/release/CHANGELOG.md
        else
          echo "No changelog found"
        fi